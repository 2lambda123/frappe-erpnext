[
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Journal Entry",
  "enabled": 1,
  "modified": "2023-10-26 00:23:05.580168",
  "module": "Accounts",
  "name": "JE-Enchancements",
  "script": "frappe.ui.form.on('Journal Entry', {\n    refresh: function(frm){\n        frm.trigger(\"transaction_currency\");\n        if(frm.doc.docstatus === 0){\n            frm.add_custom_button(__('View'), function(){\n                frappe.route_options = {\n    \t\t\t\t\"voucher_no\": frm.doc.name,\n    \t\t\t};\n                frappe.set_route(\"query-report\", \"Jiva Ledger View\");\n            }, __(\"Preview\"));\n        }\n    },\n    posting_date: function(frm, cdt, cdn){\n        frm.trigger(\"transaction_currency\");\n    },\n    transaction_currency: function(frm){\n        console.log('Test');\n        if (frm.doc.transaction_currency && frm.doc.default_company_currency){\n            frappe.call({\n\t            method: \"erpnext.setup.utils.get_exchange_rate\",\n            \targs: {\n                    \tfrom_currency: frm.doc.default_company_currency,\n                    \tto_currency: frm.doc.transaction_currency,\n                    \ttransaction_date: frm.doc.posting_date,\n                    },\n            \tcallback: function(r){\n            \t    frm.set_value(\"exchange_rate\",r.message);refresh_field(\"exchange_rate\");\n            \t    \n            \t    for (var i in frm.doc.accounts) {\n                        frm.doc.accounts[i].transaction_currency = frm.doc.transaction_currency;\n                    \tfrm.doc.accounts[i].transaction_exchange_rate = frm.doc.exchange_rate;\n                    // \tfrm.script_manager.trigger(\"account\",\"Journal Entry Account\",frm.doc.accounts[i].name );\n                    \tfrm.refresh_field(\"accounts\");\n            \t    }\n\t            }\n            });\n        }\n    },\n    \n    branch: function(frm){\n         frm.set_query(\"profit_center\", () => {\n\t\t\treturn {\n\t\t\t\tfilters: {\n\t\t\t\t\tcompany: frm.doc.company,\n\t\t\t\t\tbranch: frm.doc.branch,\n\t\t\t\t}\n\t\t\t};\n\t\t});\n    },\n    \n    profit_center: function(frm){\n        frm.set_query(\"cost_center\", () => {\n\t\t\treturn {\n\t\t\t\tfilters: {\n\t\t\t\t\tcompany: frm.doc.company,\n\t\t\t\t\tprofit_center: frm.doc.profit_center,\n\t\t\t\t}\n\t\t\t};\n\t\t});\n    },\n    \n    onload_post_render:function(frm){\n        frm.fields_dict['accounts'].grid.get_field('profit_center').get_query = function(frm, cdt, cdn) {\n          var child = locals[cdt][cdn];\n              var d = {};\n              if(child.branch){\n                d.branch = child.branch;\n              }\n              if(cur_frm.doc.company){\n                d.company = cur_frm.doc.company;\n              }\n              return{ filters: d };\n        };\n        frm.fields_dict['accounts'].grid.get_field('cost_center').get_query = function(frm, cdt, cdn) {\n          var child = locals[cdt][cdn];\n              var d = {};\n              if(child.branch){\n                d.profit_center = child.profit_center;\n                \n              }\n              if(cur_frm.doc.company){\n                d.company = cur_frm.doc.company;\n              }\n              return { filters: d };\n        };\n      },\n});\n\nfrappe.ui.form.on('Journal Entry Account', {\n    \n    account:  function(frm,cdt,cdn) {\n\t    const d = locals[cdt][cdn];\n\t    d.transaction_exchange_rate = frm.doc.exchange_rate;\n        d.transaction_currency = frm.doc.transaction_currency;\n        refresh_field(\"accounts\");\n        \n        if(d.debit_in_account_currency && frm.doc.exchange_rate ){\n            frappe.model.set_value(cdt, cdn, 'transaction_debit', d.debit_in_account_currency*frm.doc.exchange_rate);\n            frm.refresh_field(\"accounts\");\n        }\n        if(d.credit_in_account_currency && frm.doc.exchange_rate){\n            frappe.model.set_value(cdt, cdn, 'transaction_credit', d.credit_in_account_currency*frm.doc.exchange_rate);\n            frm.refresh_field(\"accounts\");\n        }\n    },\n    \n    transaction_debit:  function(frm,cdt,cdn) {\n        const d = locals[cdt][cdn];\n        if(d.transaction_debit && d.transaction_exchange_rate){\n            frappe.model.set_value(cdt, cdn, 'debit_in_account_currency', d.transaction_debit/d.transaction_exchange_rate);\n            refresh_field(\"accounts\");\n        }\n    },\n    \n    transaction_credit:  function(frm,cdt,cdn) {\n        const d = locals[cdt][cdn];\n        if(d.transaction_credit && d.transaction_exchange_rate){\n            frappe.model.set_value(cdt, cdn, 'credit_in_account_currency', d.transaction_credit/d.transaction_exchange_rate);\n            refresh_field(\"accounts\");\n        }\n    },\n    \n    debit_in_account_currency:  function(frm,cdt,cdn) {\n        const d = locals[cdt][cdn];\n        if(d.debit_in_account_currency && d.transaction_exchange_rate){\n            frappe.model.set_value(cdt, cdn, 'transaction_debit', d.debit_in_account_currency*d.transaction_exchange_rate);\n            refresh_field(\"accounts\");\n        }\n    },\n    \n    credit_in_account_currency:  function(frm,cdt,cdn) {\n        const d = locals[cdt][cdn];\n        if(d.credit_in_account_currency && d.transaction_exchange_rate){\n            frappe.model.set_value(cdt, cdn, 'transaction_credit', d.credit_in_account_currency*d.transaction_exchange_rate);\n            refresh_field(\"accounts\");\n        }\n    },\n    \n\ttransaction_currency:  function(frm,cdt,cdn) {\n\t    const d = locals[cdt][cdn];\n\t    if (d.transaction_currency){\n\t        frappe.call({\n\t            method: \"erpnext.setup.utils.get_exchange_rate\",\n            \targs: {\n                    \tfrom_currency: frm.doc.default_company_currency,\n                    \tto_currency: d.transaction_currency,\n                    \ttransaction_date: frm.doc.posting_date,\n                    },\n            \tcallback: function(r){\n            \t    frappe.model.set_value(cdt,cdn,\"transaction_exchange_rate\",r.message );\n            \t    \n            \t    frm.script_manager.trigger(\"transaction_credit\",cdt,cdn);\n            \t    frm.script_manager.trigger(\"transaction_debit\",cdt,cdn);\n                \t\n                \tfrm.refresh_field(\"accounts\");\n            \t}\n\t        });\n\t    }\n    },\n    \n});",
  "view": "Form"
 }
]